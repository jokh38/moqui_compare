# 6. 그 외 주요 기능 변화 및 개선 사항 (Other Key Feature Changes and Improvements)

**요약: `moqui_rev`는 CMake 빌드 시스템 도입, 실제 장비 로그 파일 기반의 빔 소스 모델링, 모듈화된 치료 기계 관리, 그리고 상세한 로그 및 주석 추가 등 소프트웨어 공학적 측면에서 큰 발전을 이루었습니다. 이러한 개선 사항들은 코드의 개발 생산성, 정확성, 확장성 및 유지보수성을 크게 향상시킵니다.**

---

# `moqui_rev`: 그 외 주요 기능 변화 및 개선 사항

`moqui_rev`는 앞서 분석한 5가지 핵심 기능 외에도 `moqui_v0`에 비해 소프트웨어 공학적 측면과 시뮬레이션의 정확성 및 유연성 측면에서 여러 중요한 개선이 이루어졌습니다.

## 1. 빌드 시스템 변경: CMake 도입

`moqui_v0`는 빌드 방식이 명시되어 있지 않아 개발 환경을 구축하고 코드를 컴파일하기 어려웠을 것으로 추정됩니다.

`moqui_rev`는 표준 크로스플랫폼 빌드 시스템인 **CMake**를 도입했습니다.

-   **`CMakeLists.txt`**: 프로젝트의 루트 디렉토리에 `CMakeLists.txt` 파일을 추가하여 빌드 과정을 자동화하고 표준화했습니다.
-   **장점**:
    -   **플랫폼 독립성**: Linux, macOS, Windows 등 다양한 운영체제에서 일관된 방식으로 프로젝트를 빌드할 수 있습니다.
    -   **의존성 관리 용이**: `find_package()`와 같은 CMake 명령어를 통해 CUDA, DCMTK, GDCM과 같은 외부 라이브러리 의존성을 체계적으로 찾아보고 관리할 수 있습니다.
    -   **개발 생산성 향상**: IDE(통합 개발 환경)와의 연동이 쉬워지고, 컴파일 및 테스트 과정을 단순화하여 개발자가 코드 자체에 더 집중할 수 있게 합니다.

## 2. 로그 파일 기반 빔 소스 모델링

기존 방식은 DICOM RTPLAN에 정의된 이론적인 빔 모델을 사용했습니다. `moqui_rev`는 여기서 한 단계 더 나아가, **실제 치료 장비에서 생성된 로그 파일(CSV 형식)을 직접 읽어** 빔 소스를 모델링하는 기능을 추가했습니다.

-   **구현**:
    -   `mqi_tps_env.hpp`에 `read_logfile_dir()` 함수가 추가되어 특정 디렉토리의 CSV 로그 파일들을 읽습니다.
    -   `mqi_treatment_machine_smc_gtr2.hpp`에 `create_beamsource(logfileData, ...)` 함수가 추가되어, 파싱된 로그 데이터(실제 빔의 에너지, 위치, MU값 등)를 기반으로 `mqi::beamsource` 객체를 생성합니다.
-   **장점**:
    -   **시뮬레이션 정확도 향상**: 이론적인 계획 값이 아닌, 실제 장비의 출력 특성이 반영된 데이터를 사용하므로 시뮬레이션의 정확성과 신뢰도를 크게 높일 수 있습니다.
    -   **QA 및 검증**: 치료 계획(TPS)과 실제 장비 출력 사이의 차이를 분석하고 검증하는 데 매우 유용합니다.

```cpp
// moqui_rev/moqui/base/environments/mqi_tps_env.hpp

// 로그 파일을 읽어 빔 소스를 생성하는 새로운 워크플로우
logfiles_t logFileData = read_logfile_dir(bnb - 1);
this->beamsource = this->tx->get_beamsource(logFileData, p_final, sid, rangeShifterUsed);
```

## 3. 모듈화된 치료 기계 및 물질 관리

`moqui_v0`가 일반적인(generic) PBS 모델을 사용한 것에 반해, `moqui_rev`는 **특정 치료 기계를 클래스로 모델링**하여 관리합니다.

-   **구현**:
    -   `moqui/treatment_machines/` 디렉토리 아래에 `mqi_treatment_machine_smc_gtr1.hpp`, `mqi_treatment_machine_smc_gtr2.hpp` 등 특정 장비 모델 파일이 추가되었습니다.
    -   각 기계 모델 클래스는 자신의 고유한 빔라인 구성(SAD, Range Shifter 사양 등)과 물질 정보(`gtr2_material_t`)를 정의합니다.
-   **장점**:
    -   **모듈성 및 확장성**: 새로운 치료 장비를 추가해야 할 경우, 해당 장비의 특성을 정의하는 새로운 클래스 파일만 추가하면 되므로 시스템 확장이 매우 용이합니다.
    -   **유지보수성**: 장비별 코드가 분리되어 있어 특정 장비의 모델을 수정하거나 디버깅하기가 편리합니다.

## 4. 코드 품질 및 문서화 개선

`moqui_rev`는 전반적인 코드의 품질과 문서화 수준이 크게 향상되었습니다.

-   **상세한 로그 출력**: 시뮬레이션의 주요 단계(데이터 로딩, 객체 생성, 시뮬레이션 진행 등)에서 `std::cout`을 통해 상세한 정보와 진행 상황을 출력하여, 사용자가 프로그램의 동작을 쉽게 파악하고 디버깅할 수 있도록 돕습니다.
-   **체계적인 주석**: 파일 및 주요 기능의 역할을 설명하는 Doxygen 스타일의 주석(`/// \file`, `/// \brief`)이 적극적으로 사용되었습니다.
-   **명시적인 개발 계획**: `TODO` 주석을 사용하여 현재 미구현된 기능이나 향후 개선할 부분을 명확히 표시하여 코드의 발전 방향을 쉽게 알 수 있습니다.
-   **`README.md` 문서**: 프로젝트의 개요, 빌드 방법, 사용법, 외부 의존성 등 프로젝트를 이해하고 사용하는 데 필요한 필수 정보를 체계적으로 제공합니다.

이러한 개선 사항들은 `moqui_rev`를 단순한 연구용 코드를 넘어, 여러 개발자가 협업하고 지속적으로 발전시킬 수 있는 잘 만들어진 소프트웨어 프로젝트로 만들어주는 중요한 요소입니다.
